## 云原生构建
基于云原生构建，实现监听git仓库的操作实现自动构建出docker镜像或者k8s的镜像

想达到的效果是： 当想git仓库指定分支(master\release)分支提交代码、或者打tag时，可以自动构建镜像，并提交到指定的仓库中

### 可以监听哪些git操作
常见的有push、tag_push、指定分支的merge_request
```yaml
push:

tag_push:

master:
  merge_request:
```

### 项目中构建的流程
基于云原生工具，监听目标的git仓库，当master.merge_request时，检查相关操作、当push tag时，做相关操作，并打出镜像推送到docker仓库中

流程：
前置：编译期，基于编译期的dockerfile打包出一个基础镜像，该镜像包含了解析git命名的脚本和构建docker镜像的脚本  -- 只要处理一次就好
> 环境依赖，比如yum install 一些依赖项
> 脚本依赖，比如解析git命令的、docker构建的

1、通过编译期的docker基础镜像，在此基础之上构建版本
2、前提检查，解析git命名，比如拿到git服务地址、服务名称，build_tag,docker 仓库地址，docker镜像版本，构建环境；然后执行代码检查命令

代码前置检查
```text
  - golangci-lint run -c .golangci.yml
  - go test ./... -race
```
3、执行docker镜像的脚本，生成docker镜像
```shell
# cd到指定的服务目录中
cd ./${SERVER_PATH}
# 如果有makefile就执行make操作，如果没有直接执行go build操作
if [ -f "Makefile" ]; then
    make
else
    go build -gcflags '-N -l' -o "srv"
fi
# 执行docker build 指定名称为 server 使用当前目录下的dockerfile
docker build --network=host -t server .

# 生成docker tag名称
DOCKER_IMAGE=${DOCKER_HUB_MAINLINE}:${DOCKER_TAG}
# 生成docker tag
docker tag server $DOCKER_IMAGE
# docker push 到远端
docker push $DOCKER_IMAGE
echo "$DOCKER_IMAGE" >> aaa.txt

# 生成最新的tag并推送到远端
DOCKER_IMAGE=${DOCKER_HUB_MAINLINE}:latest
docker tag server $DOCKER_IMAGE
docker push $DOCKER_IMAGE
```


### makefile ？
```makefile
BuildBranch := $(shell git rev-parse --abbrev-ref HEAD)
BuildCommit := $(shell git rev-parse --short HEAD)
BuildTime := $(shell date  +"%Y/%m/%d %H:%M.%S %Z")
```