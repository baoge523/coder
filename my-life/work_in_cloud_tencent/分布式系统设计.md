## 分布式系统设计

在微服务架构设计中，将一个大而全的服务，按照其功能拆分成不同的服务，服务直接通过网络的方式访问，通常是http、rpc等

拆分成微服务的优缺点

优点:
 - 服务功能单一，符合单一原则
 - 功能变更时，只需要升级对应的服务即可，不需要升级整体
 - 

缺点:
 - 拆分后的服务基于网络访问，效率比内存访问低100倍
 - 存在网络问题
 - 服务拆分过多，维护比较困难，比如服务发现、服务注册、服务寻址、服务熔断与降级
 - 数据一致性问题的保证


### 在分布式下，数据一致性成为一个业务困难点

数据一致性的方案：
- 强一致性
- 弱一致性
- 最终一致性

强一致性： 在业务功能中，每时每刻都是一致性
弱一致性  不保证，数据是一致性的
最终一致性，是一个弱一致性的实现，表示在经过一段时间后，在某一时刻后，数据最终是一致的

保证一致性的方式有哪些：
- 2PC
- 3PC
- TCC 阿里的

2pc
```text

```

3pc
```text

```

tcc
```text
TCC的定义

Try: 尝试执行业务

完成所有业务检查（一致性）
预留必须业务资源（准隔离性）
Confirm: 确认执行业务

真正执行业务
不作任何业务检查
只使用Try阶段预留的业务资源
Confirm操作满足幂等性
Cancel: 取消执行业务

释放Try阶段预留的业务资源
Cancel操作满足幂等性
```

CAP理论
```text
一个经典的分布式系统理论。CAP理论告诉我们：一个分布式系统不可能同时满足一致性（C：Consistency）、可用性（A：Availability）和分区容忍性（P：Partition tolerance）这三个基本需求，最多只能同时满足其中两项。

1、一致性

对于一个将数据副本分布在不同分布式节点上的系统来说，如果对第一个节点的数据进行了更新操作并且更新成功后，却没有使得第二个节点上的数据得到相应的更新，于是在对第二个节点的数据进行读取操作时，获取的依然是老数据（或称为脏数据），这就是典型的分布式数据不一致的情况。**在分布式系统中，如果能够做到针对一个数据项的更新操作执行成功后，所有的用户都可以读取到其最新的值，那么这样的系统就被认为具有强一致性**。

对于多个节点配合才能完成的操作，所有参与这个操作的节点的数据变动应该是同步的。

2、可用性

可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够**在有限的时间内返回结果**。这里的重点是"有限时间内"和"返回结果"。

"有限时间内"是指，对于用户的一个操作请求，系统必须能够在指定的时间内返回对应的处理结果，如果超过了这个时间范围，那么系统就被认为是不可用的。另外，"有限的时间内"是指系统设计之初就设计好的运行指标，通常不同系统之间有很大的不同，无论如何，对于用户请求，系统必须存在一个合理的响应时间，否则用户便会对系统感到失望。

"返回结果"是可用性的另一个非常重要的指标，它要求系统在完成对用户请求的处理后，返回一个正常的响应结果。正常的响应结果通常能够明确地反映出队请求的处理结果，即成功或失败，而不是一个让用户感到困惑的返回结果。

3、分区容忍性

分区容忍性约束了一个分布式系统具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。
```

选择	说明
CA	放弃分区容忍性，加强一致性和可用性，其实就是传统的单机数据库的选择
AP	放弃一致性（这里说的一致性是强一致性），追求分区容忍性和可用性，这是很多分布式系统设计时的选择，例如很多NoSQL系统就是如此
CP	放弃可用性，追求一致性和分区容忍性，基本不会选择，网络问题会直接让整个系统不可用

BASE理论
```text
BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的缩写。BASE理论是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的。BASE理论的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性
```

