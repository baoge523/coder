## write ahead log  预写日志
Write-Ahead Log (预写式日志) 是一种数据安全机制
> 在将数据的修改持久化到实际的数据文件（主数据存储）之前，必须先将这个修改操作持久化到日志文件中


工作原理（简化步骤）：

1.记录日志：当有一个数据修改操作（例如，更新某一行数据）发生时，系统不会直接去磁盘上的数据库文件里修改原始数据。

2.写入日志：系统会先将这个修改操作（包括修改了哪个数据页、具体内容是什么等）作为一个日志记录，顺序地追加写入到 WAL 文件中。这个写入操作是顺序写入。

3.刷盘 (Fsync)：在大多数严格要求持久性的场景下，系统会调用 fsync等操作，确保这条日志记录被物理地写入到磁盘存储器上。

4.应用修改：只有在日志记录被安全地持久化到磁盘之后，系统才会将实际的修改应用（写入）到主数据文件或内存中的数据结构（如 Buffer Pool）。

5.提交确认：对于数据库事务，通常在步骤 3 完成后，就可以向客户端返回“提交成功”的信号。


在上面的工作流程中，只要3完成了，就可以说该修改操作是成功的； 因为如果在3之后程序crash,在程序重启后，会重放wal文件，并将其中的修改写入到主数据中



#### WAL带来了哪些性能提升
1、将随机的io磁盘写入，改成了顺序的io写入  -- 通常顺序的io写入比随机的io写入高出几个数量级
2、可以合并多次写入，我们可以将多个事务批量的写入wal文件中，使用一个刷盘操作(fsync)，将日志落盘；极大地减少了昂贵的 fsync操作；显著提升了在高并发写入场景下的性能
3、异步化主数据写入操作；在高并发场景下，写入wal中就保证了数据已经持久化成功了，异步刷入到主数据中，可以等程序空闲的时候(cpu、磁盘)压力不大时操作
4、减少数据量，如果直接写主数据的话，及时修改一个字节，也会加载更多的字节(计算机都是按页读取的，16k)
5、加速事务的提交(避免大事务) -- 只需要写WAL即可，不需要等主数据写完落盘(存在脏页合并等操作)


#### WAL的核心技术是：将随机写转换成顺序写
Write-Ahead Log (WAL) 是一种通过将随机写转换为顺序写并兼顾数据持久性和高性能写入的核心技术。
它牺牲了一点额外的写操作（写日志），却换来了：
> 1.极强的数据可靠性（崩溃恢复）。
> 2.显著更高的写入吞吐量和更低的事务提交延迟。

### WAL的应用场景
mysql 中的redo log
kafka 生产者生产消息顺序写入主题的分区文件中，本身就是一种WAL的应用
etcd  基于WAL持久化Raft算法的日志条目，保证了数据的一致性、可靠性
